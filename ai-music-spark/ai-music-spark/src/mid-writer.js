// A simplified version of midi-writer-js by grimmdude
// This will allow us to generate a MIDI file in the browser.
(function(t){"use strict";function e(t){this.data=t}function i(t){this.type=t.type,this.channel=t.channel,this.param1=t.param1,this.param2=t.param2}function n(t){this.type=t.type,this.channel=t.channel,this.param1=t.param1}function s(t){this.type=t.type,this.channel=t.channel,this.param1=t.param1}function o(t){this.type=t.type,this.channel=t.channel,this.param1=t.param1}function r(t){this.type=t.type,this.channel=t.channel,this.param1=t.param1}function h(t){this.type=t.type,this.value=t.value}function a(t){this.type=t.type,this.value=t.value}function d(t){this.type=t.type,this.text=t.text}function c(t){this.type=t.type,this.text=t.text}function l(t){this.type=t.type,this.text=t.text}function p(t){this.type=t.type,this.text=t.text}function u(t){this.type=t.type,this.text=t.text}function g(t){this.type=t.type,this.number=t.number,this.text=t.text}function f(t){this.type=t.type,this.number=t.number,this.text=t.text}function m(t){this.type=t.type,this.text=t.text}function y(t){this.type=t.type,this.data=t.data}function b(t){this.type=t.type,this.data=t.data}function k(t){this.type=t.type,this.smpteOffset=t.smpteOffset,this.data=t.data}function v(t){this.type=t.type,this.numerator=t.numerator,this.denominator=t.denominator,this.metronome=t.metronome,this.thirtyseconds=t.thirtyseconds}function w(t){this.type=t.type,this.key=t.key,this.scale=t.scale}function V(t){this.type=t.type}function T(t,e,i,n,s){this.startTick=t,this.channel=i,this.pitch=s,this.duration=this.getDuration(e,n),this.velocity=100,this.wait=0}function M(){this.events=[],this.lastTick=0,this.lastEvent={}}function x(t){this.data=t}x.prototype.setTempo=function(t){this.data[0]=6,this.data[1]=t>>16&255,this.data[2]=t>>8&255,this.data[3]=255&t},T.prototype.getDuration=function(t,e){return"number"!=typeof t&&"string"!=typeof t||(t=this.getTickDuration(t,e)),t},T.prototype.getTickDuration=function(t,e){var i;if(e=e||this.duration,"number"==typeof e)i=e;else{var n={"1":4*t,"2":2*t,"4":t,"8":t/2,"16":t/4,"32":t/8};if(e.toString().indexOf("d")>0){var s=e.match(/(\d+)/);i=1.5*n[s[0]]}else{var o=e.match(/(\d+)/);i=n[o[0]]}}return i},T.prototype.getPitch=function(t){var e=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"],i=t.match(/([CDEFGAB])(#?)(\d+)/),n=e.indexOf(i[1].toUpperCase()+(i[2]?i[2]:""));return 12*parseInt(i[3])+n+12},T.prototype.getWait=function(t,e){if(e=e||this.wait,"number"==typeof e)return this.numToBytes(e,this.getVLVSize(e));if("string"==typeof e){var i=this.getTickDuration(t,e);return this.numToBytes(i,this.getVLVSize(i))}console.log("Error: invalid wait value.")},T.prototype.setWait=function(t){return this.wait=t,this},T.prototype.setVelocity=function(t){return this.velocity=t,this},T.prototype.getTicks=function(t){return t},M.prototype.addEvent=function(t){Array.isArray(t)||console.log("Error: addEvent() requires an array."),this.events=this.events.concat(t),this.lastTick+=t[0].duration,this.lastEvent=t[t.length-1]},M.prototype.getEventBytes=function(){for(var t=[],o=0;o<this.events.length;o++){var h;if("note"===this.events[o].type)h=[[new e(this.getWait(this.events[o].tickDuration,this.events[o].wait)),new i({channel:this.events[o].channel,type:9,param1:this.events[o].pitch,param2:this.events[o].velocity})],[new e(this.getWait(this.events[o].tickDuration,this.events[o].duration)),new i({channel:this.events[o].channel,type:8,param1:this.events[o].pitch,param2:this.events[o].velocity})]];else if("program"===this.events[o].type)h=[[new e(this.getWait(this.events[o].tickDuration,this.events[o].wait)),new n({channel:this.events[o].channel,type:12,param1:this.events[o].number})]];else if("pitch"===this.events[o].type)h=[[new e(this.getWait(this.events[o].tickDuration,this.events[o].wait)),new s({channel:this.events[o].channel,type:14,param1:this.events[o].lsb,param2:this.events[o].msb})]];else if("controller"===this.events[o].type)h=[[new e(this.getWait(this.events[o].tickDuration,this.events[o].wait)),new r({channel:this.events[o].channel,type:11,param1:this.events[o].number,param2:this.events[o].value})]];else if("meta"===this.events[o].type){var a;switch(this.events[o].metaType){case"sequenceNumber":a=new f({type:255,number:0,text:this.events[o].number});break;case"text":a=new d({type:255,text:this.events[o].text});break;case"copyright":a=new c({type:255,text:this.events[o].text});break;case"trackName":a=new l({type:255,text:this.events[o].text});break;case"instrumentName":a=new p({type:255,text:this.events[o].text});break;case"lyrics":a=new u({type:255,text:this.events[o].text});break;case"marker":a=new g({type:255,number:6,text:this.events[o].text});break;case"cuePoint":a=new m({type:255,text:this.events[o].text});break;case"channelPrefix":a=new y({type:255,data:32});break;case"endOfTrack":a=new V({type:255});break;case"setTempo":a=new b({type:255,data:[81,3,this.events[o].tempo>>16&255,this.events[o].tempo>>8&255,255&this.events[o].tempo]});break;case"smpteOffset":a=new k({type:255,smpteOffset:84,data:[0,0,0,0,0]});break;case"timeSignature":a=new v({type:255,numerator:this.events[o].numerator,denominator:this.events[o].denominator,metronome:this.events[o].metronome,thirtyseconds:this.events[o].thirtyseconds});break;case"keySignature":a=new w({type:255,key:this.events[o].key,scale:this.events[o].scale});break;case"sequencerSpecific":a=new h({type:255,value:this.events[o].value});break;case"unknown":a=new a({type:255,value:void 0})}h=[[new e(this.getWait(this.events[o].tickDuration,this.events[o].wait)),a]]}t.push.apply(t,h)}return t},M.prototype.setTickDuration=function(t){this.tickDuration=t},e.prototype.numToBytes=function(t,e){e=e||1;var i=[];if(t>Math.pow(2,8*e)-1)return console.log("Error: numToBytes() trying to store "+t+" in "+e+" bytes.");for(var n=e-1;n>=0;n--)i.push(t>>8*n&255);return i},e.prototype.getVLVSize=function(t){return 128>t?1:16384>t?2:2097152>t?3:4},e.prototype.toBytes=function(){var t=this.numToBytes(this.data,this.getVLVSize(this.data));return t.length>1&&(t[0]|=128,t[1]|=128,t[2]|=128),t},i.prototype.toBytes=function(){var t=16*(this.type-1)+this.channel-1;return[t,this.param1,this.param2]},n.prototype.toBytes=function(){var t=16*(this.type-1)+this.channel-1;return[t,this.param1]},s.prototype.toBytes=function(){var t=16*(this.type-1)+this.channel-1;return[t,this.param1,this.param2]},r.prototype.toBytes=function(){var t=16*(this.type-1)+this.channel-1;return[t,this.param1,this.param2]},d.prototype.toBytes=function(){return[this.type,1,this.text.length].concat(this.stringToBytes(this.text))},c.prototype.toBytes=function(){return[this.type,2,this.text.length].concat(this.stringToBytes(this.text))},l.prototype.toBytes=function(){return[this.type,3,this.text.length].concat(this.stringToBytes(this.text))},p.prototype.toBytes=function(){return[this.type,4,this.text.length].concat(this.stringToBytes(this.text))},u.prototype.toBytes=function(){return[this.type,5,this.text.length].concat(this.stringToBytes(this.text))},g.prototype.toBytes=function(){return[this.type,6,this.text.length].concat(this.stringToBytes(this.text))},m.prototype.toBytes=function(){return[this.type,7,this.text.length].concat(this.stringToBytes(this.text))},y.prototype.toBytes=function(){return[this.type,32,1,this.data]},b.prototype.toBytes=function(){return[this.type].concat(this.data)},V.prototype.toBytes=function(){return[this.type,47,0]},k.prototype.toBytes=function(){return[this.type,this.smpteOffset,5].concat(this.data)},v.prototype.toBytes=function(t){return[this.type,88,4,this.numerator,this.denominator,this.metronome,this.thirtyseconds]},w.prototype.toBytes=function(){return[this.type,89,2,this.key,this.scale]},h.prototype.toBytes=function(){return[this.type,127,this.value.length].concat(this.value)},a.prototype.toBytes=function(){return[this.type,this.value,0]},f.prototype.toBytes=function(){return[this.type,0,2,this.number>>8&255,255&this.number]},T.prototype.stringToBytes=function(t){for(var e=[],i=0;i<t.length;i++)e.push(t.charCodeAt(i));return e},e.prototype.stringToBytes=function(t){for(var e=[],i=0;i<t.length;i++)e.push(t.charCodeAt(i));return e},T.prototype.numToBytes=function(t,e){e=e||1;var i=[];if(t>Math.pow(2,8*e)-1)return console.log("Error: numToBytes() trying to store "+t+" in "+e+" bytes.");for(var n=e-1;n>=0;n--)i.push(t>>8*n&255);return i},e.prototype.numToBytes=function(t,e){e=e||1;var i=[];if(t>Math.pow(2,8*e)-1)return console.log("Error: numToBytes() trying to store "+t+" in "+e+" bytes.");for(var n=e-1;n>=0;n--)i.push(t>>8*n&255);return i},i.prototype.numToBytes=function(t,e){e=e||1;var i=[];if(t>Math.pow(2,8*e)-1)return console.log("Error: numToBytes() trying to store "+t+" in "+e+" bytes.");for(var n=e-1;n>=0;n--)i.push(t>>8*n&255);return i},n.prototype.numToBytes=function(t,e){e=e||1;var i=[];if(t>Math.pow(2,8*e)-1)return console.log("Error: numToBytes() trying to store "+t+" in "+e+" bytes.");for(var n=e-1;n>=0;n--)i.push(t>>8*n&255);return i},s.prototype.numToBytes=function(t,e){e=e||1;var i=[];if(t>Math.pow(2,8*e)-1)return console.log("Error: numToBytes() trying to store "+t+" in "+e+" bytes.");for(var n=e-1;n>=0;n--)i.push(t>>8*n&255);return i},r.prototype.numToBytes=function(t,e){e=e||1;var i=[];if(t>Math.pow(2,8*e)-1)return console.log("Error: numToBytes() trying to store "+t+" in "+e+" bytes.");for(var n=e-1;n>=0;n--)i.push(t>>8*n&255);return i},d.prototype.numToBytes=function(t,e){e=e||1;var i=[];if(t>Math.pow(2,8*e)-1)return console.log("Error: numToBytes() trying to store "+t+" in "+e+" bytes.");for(var n=e-1;n>=0;n--)i.push(t>>8*n&255);return i},c.prototype.numToBytes=function(t,e){e=e||1;var i=[];if(t>Math.pow(2,8*e)-1)return console.log("Error: numToBytes() trying to store "+t+" in "+e+" bytes.");for(var n=e-1;n>=0;n--)i.push(t>>8*n&255);return i},l.prototype.numToBytes=function(t,e){e=e||1;var i=[];if(t>Math.pow(2,8*e)-1)return console.log("Error: numToBytes() trying to store "+t+" in "+e+" bytes.");for(var n=e-1;n>=0;n--)i.push(t>>8*n&255);return i},p.prototype.numToBytes=function(t,e){e=e||1;var i=[];if(t>Math.pow(2,8*e)-1)return console.log("Error: numToBytes() trying to store "+t+" in "+e+" bytes.");for(var n=e-1;n>=0;n--)i.push(t>>8*n&255);return i},u.prototype.numToBytes=function(t,e){e=e||1;var i=[];if(t>Math.pow(2,8*e)-1)return console.log("Error: numToBytes() trying to store "+t+" in "+e+" bytes.");for(var n=e-1;n>=0;n--)i.push(t>>8*n&255);return i},g.prototype.numToBytes=function(t,e){e=e||1;var i=[];if(t>Math.pow(2,8*e)-1)return console.log("Error: numToBytes() trying to store "+t+" in "+e+" bytes.");for(var n=e-1;n>=0;n--)i.push(t>>8*n&255);return i},f.prototype.numToBytes=function(t,e){e=e||1;var i=[];if(t>Math.pow(2,8*e)-1)return console.log("Error: numToBytes() trying to store "+t+" in "+e+" bytes.");for(var n=e-1;n>=0;n--)i.push(t>>8*n&255);return i},m.prototype.numToBytes=function(t,e){e=e||1;var i=[];if(t>Math.pow(2,8*e)-1)return console.log("Error: numToBytes() trying to store "+t+" in "+e+" bytes.");for(var n=e-1;n>=0;n--)i.push(t>>8*n&255);return i},y.prototype.numToBytes=function(t,e){e=e||1;var i=[];if(t>Math.pow(2,8*e)-1)return console.log("Error: numToBytes() trying to store "+t+" in "+e+" bytes.");for(var n=e-1;n>=0;n--)i.push(t>>8*n&255);return i},b.prototype.numToBytes=function(t,e){e=e||1;var i=[];if(t>Math.pow(2,8*e)-1)return console.log("Error: numToBytes() trying to store "+t+" in "+e+" bytes.");for(var n=e-1;n>=0;n--)i.push(t>>8*n&255);return i},k.prototype.numToBytes=function(t,e){e=e||1;var i=[];if(t>Math.pow(2,8*e)-1)return console.log("Error: numToBytes() trying to store "+t+" in "+e+" bytes.");for(var n=e-1;n>=0;n--)i.push(t>>8*n&255);return i},v.prototype.numToBytes=function(t,e){e=e||1;var i=[];if(t>Math.pow(2,8*e)-1)return console.log("Error: numToBytes() trying to store "+t+" in "+e+" bytes.");for(var n=e-1;n>=0;n--)i.push(t>>8*n&255);return i},w.prototype.numToBytes=function(t,e){e=e||1;var i=[];if(t>Math.pow(2,8*e)-1)return console.log("Error: numToBytes() trying to store "+t+" in "+e+" bytes.");for(var n=e-1;n>=0;n--)i.push(t>>8*n&255);return i},V.prototype.numToBytes=function(t,e){e=e||1;var i=[];if(t>Math.pow(2,8*e)-1)return console.log("Error: numToBytes() trying to store "+t+" in "+e+" bytes.");for(var n=e-1;n>=0;n--)i.push(t>>8*n&255);return i},h.prototype.numToBytes=function(t,e){e=e||1;var i=[];if(t>Math.pow(2,8*e)-1)return console.log("Error: numToBytes() trying to store "+t+" in "+e+" bytes.");for(var n=e-1;n>=0;n--)i.push(t>>8*n&255);return i},a.prototype.numToBytes=function(t,e){e=e||1;var i=[];if(t>Math.pow(2,8*e)-1)return console.log("Error: numToBytes() trying to store "+t+" in "+e+" bytes.");for(var n=e-1;n>=0;n--)i.push(t>>8*n&255);return i},d.prototype.stringToBytes=function(t){for(var e=[],i=0;i<t.length;i++)e.push(t.charCodeAt(i));return e},c.prototype.stringToBytes=function(t){for(var e=[],i=0;i<t.length;i++)e.push(t.charCodeAt(i));return e},l.prototype.stringToBytes=function(t){for(var e=[],i=0;i<t.length;i++)e.push(t.charCodeAt(i));return e},p.prototype.stringToBytes=function(t){for(var e=[],i=0;i<t.length;i++)e.push(t.charCodeAt(i));return e},u.prototype.stringToBytes=function(t){for(var e=[],i=0;i<t.length;i++)e.push(t.charCodeAt(i));return e},g.prototype.stringToBytes=function(t){for(var e=[],i=0;i<t.length;i++)e.push(t.charCodeAt(i));return e},m.prototype.stringToBytes=function(t){for(var e=[],i=0;i<t.length;i++)e.push(t.charCodeAt(i));return e},T.prototype.getEventBytes=function(t){for(var s,o=0,r=0;r<this.events.length;r++){var c;if("note"===this.events[r].type){var l=this.events[r].channel,p=this.events[r].pitch,u=this.events[r].velocity,g=this.events[r].duration,f=this.events[r].wait;o+=this.getVLVSize(f),o+=3,o+=this.getVLVSize(g),o+=3}else if("program"===this.events[r].type)o+=this.getVLVSize(f),o+=2;else if("pitch"===this.events[r].type)o+=this.getVLVSize(f),o+=3;else if("controller"===this.events[r].type)o+=this.getVLVSize(f),o+=3;else if("meta"===this.events[r].type){var m;switch(this.events[r].metaType){case"sequenceNumber":m=new f({type:255,number:this.events[r].number});break;case"text":m=new d({type:255,text:this.events[r].text});break;case"copyright":m=new c({type:255,text:this.events[r].text});break;case"trackName":m=new l({type:255,text:this.events[r].text});break;case"instrumentName":m=new p({type:255,text:this.events[r].text});break;case"lyrics":m=new u({type:255,text:this.events[r].text});break;case"marker":m=new g({type:255,number:6,text:this.events[r].text});break;case"cuePoint":m=new m({type:255,text:this.events[r].text});break;case"channelPrefix":m=new y({type:255,data:32});break;case"endOfTrack":m=new V({type:255});break;case"setTempo":m=new b({type:255,data:[81,3,this.events[r].tempo>>16&255,this.events[r].tempo>>8&255,255&this.events[r].tempo]});break;case"smpteOffset":m=new k({type:255,smpteOffset:84,data:[0,0,0,0,0]});break;case"timeSignature":m=new v({type:255,numerator:this.events[r].numerator,denominator:this.events[r].denominator,metronome:this.events[r].metronome,thirtyseconds:this.events[r].thirtyseconds});break;case"keySignature":m=new w({type:255,key:this.events[r].key,scale:this.events[r].scale});break;case"sequencerSpecific":m=new h({type:255,value:this.events[r].value});break;case"unknown":m=new a({type:255,value:void 0})}c=m.toBytes(),o+=c.length}s=o}var k=this.numToBytes(s,4);k=[77,84,114,107].concat(k);for(var r=0;r<this.events.length;r++){var T;if("note"===this.events[r].type){var M=this.events[r].channel,x=this.events[r].pitch,C=this.events[r].velocity,E=this.events[r].duration,N=this.events[r].wait;T=new e(N).toBytes().concat(new i({channel:M,type:9,param1:x,param2:C}).toBytes()).concat(new e(E).toBytes()).concat(new i({channel:M,type:8,param1:x,param2:C}).toBytes())}else if("program"===this.events[r].type){var S=this.events[r].channel,L=this.events[r].number,N=this.events[r].wait;T=new e(N).toBytes().concat(new n({channel:S,type:12,param1:L}).toBytes())}else if("pitch"===this.events[r].type){var S=this.events[r].channel,j=this.events[r].value,N=this.events[r].wait;T=new e(N).toBytes().concat(new s({channel:S,type:14,param1:j&127,param2:j>>7&127}).toBytes())}else if("controller"===this.events[r].type){var S=this.events[r].channel,L=this.events[r].number,D=this.events[r].value,N=this.events[r].wait;T=new e(N).toBytes().concat(new r({channel:S,type:11,param1:L,param2:D}).toBytes())}else if("meta"===this.events[r].type){var m;switch(this.events[r].metaType){case"sequenceNumber":m=new f({type:255,number:this.events[r].number});break;case"text":m=new d({type:255,text:this.events[r].text});break;case"copyright":m=new c({type:255,text:this.events[r].text});break;case"trackName":m=new l({type:255,text:this.events[r].text});break;case"instrumentName":m=new p({type:255,text:this.events[r].text});break;case"lyrics":m=new u({type:255,text:this.events[r].text});break;case"marker":m=new g({type:255,number:6,text:this.events[r].text});break;case"cuePoint":m=new m({type:255,text:this.events[r].text});break;case"channelPrefix":m=new y({type:255,data:32});break;case"endOfTrack":m=new V({type:255});break;case"setTempo":m=new b({type:255,data:[81,3,this.events[r].tempo>>16&255,this.events[r].tempo>>8&255,255&this.events[r].tempo]});break;case"smpteOffset":m=new k({type:255,smpteOffset:84,data:[0,0,0,0,0]});break;case"timeSignature":m=new v({type:255,numerator:this.events[r].numerator,denominator:this.events[r].denominator,metronome:this.events[r].metronome,thirtyseconds:this.events[r].thirtyseconds});break;case"keySignature":m=new w({type:255,key:this.events[r].key,scale:this.events[r].scale});break;case"sequencerSpecific":m=new h({type:255,value:this.events[r].value});break;case"unknown":m=new a({type:255,value:void 0})}T=new e(N).toBytes().concat(m.toBytes())}k=k.concat(T)}return k},M.prototype.getVLVSize=function(t){return 128>t?1:16384>t?2:2097152>t?3:4},M.prototype.numToBytes=function(t,e){e=e||1;var i=[];if(t>Math.pow(2,8*e)-1)return console.log("Error: numToBytes() trying to store "+t+" in "+e+" bytes.");for(var n=e-1;n>=0;n--)i.push(t>>8*n&255);return i},T.prototype.getVLVSize=function(t){return 128>t?1:16384>t?2:2097152>t?3:4},T.prototype.numToBytes=function(t,e){e=e||1;var i=[];if(t>Math.pow(2,8*e)-1)return console.log("Error: numToBytes() trying to store "+t+" in "+e+" bytes.");for(var n=e-1;n>=0;n--)i.push(t>>8*n&255);return i};var C=function(t){this.tracks=t,this.startTicks=0,this.track=new M,this.track.setTickDuration(128)};C.prototype.stringToBytes=function(t){for(var e=[],i=0;i<t.length;i++)e.push(t.charCodeAt(i));return e},C.prototype.numToBytes=function(t,e){e=e||1;var i=[];if(t>Math.pow(2,8*e)-1)return console.log("Error: numToBytes() trying to store "+t+" in "+e+" bytes.");for(var n=e-1;n>=0;n--)i.push(t>>8*n&255);return i},C.prototype.getTrk=function(t){return this.tracks[t].getEventBytes()},C.prototype.getHeader=function(){var t=this.numToBytes(1,2),e=this.numToBytes(this.tracks.length,2),i=this.numToBytes(128,2);return[77,84,104,100,0,0,0,6].concat(t).concat(e).concat(i)},C.prototype.getAllTracks=function(){for(var t=[],e=0;e<this.tracks.length;e++)t.push.apply(t,this.getTrk(e));return t},C.prototype.buildFile=function(){var e=this.getHeader().concat(this.getAllTracks());return t?new Blob([new Uint8Array(e)],{type:"audio/midi"}):e},C.prototype.buildDataURI=function(){var t=this.buildFile();return"data:audio/midi;base64,"+btoa(String.fromCharCode.apply(null,t))},C.prototype.NoteEvent=function(t){var e=t.pitch.map(function(e){return"string"==typeof e?this.getPitch(e):e},this);t.pitch=e,t.type="note",this.track.addEvent(t)},C.prototype.ProgramChangeEvent=function(t){t.type="program",this.track.addEvent(t)},C.prototype.PitchBendEvent=function(t){t.type="pitch",this.track.addEvent(t)},C.prototype.ControllerEvent=function(t){t.type="controller",this.track.addEvent(t)},C.prototype.MetaEvent=function(t){t.type="meta",this.track.addEvent(t)},C.prototype.Track=function(){var t=new M;return t.setTickDuration(this.track.tickDuration),this.tracks.push(t),t},C.prototype.getPitch=function(t){var e=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"],i=t.match(/([CDEFGAB])(#?)(\d+)/),n=e.indexOf(i[1].toUpperCase()+(i[2]?i[2]:""));return 12*parseInt(i[3])+n+12},T.prototype.constructor=T,M.prototype.constructor=M,C.prototype.constructor=C,"function"==typeof define&&define.amd?define("MidiWriter",C):"undefined"!=typeof module&&module.exports?module.exports=C:t.MidiWriter=C})(this);